<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'sensitive_data_guard', plugin: 'redmine_sensitive_data_guard' %>
<% end %>

<div class="contextual">
  <%= link_to 'ğŸ“Š å¯©æ ¸çµ±è¨ˆ', statistics_reviews_path, class: 'icon icon-stats' %>
  <%= link_to 'ğŸ“‹ æ•æ„Ÿæ—¥èªŒ', sensitive_logs_path, class: 'icon icon-list' %>
</div>

<h2>ğŸ” æ•æ„Ÿè³‡æ–™å¯©æ ¸ç®¡ç†</h2>

<!-- çµ±è¨ˆæ¦‚è¦½ -->
<div class="statistics-overview">
  <div class="stat-card">
    <h3>å¾…å¯©æ ¸</h3>
    <div class="stat-number pending"><%= @statistics[:total_pending] %></div>
  </div>
  <div class="stat-card">
    <h3>å·²æ ¸å‡†</h3>
    <div class="stat-number approved"><%= @statistics[:total_approved] %></div>
  </div>
  <div class="stat-card">
    <h3>å·²æ‹’çµ•</h3>
    <div class="stat-number rejected"><%= @statistics[:total_rejected] %></div>
  </div>
  <div class="stat-card">
    <h3>å¯©æ ¸ç‡</h3>
    <div class="stat-number"><%= @statistics[:review_rate] %>%</div>
  </div>
</div>

<!-- ç¯©é¸è¡¨å–® -->
<%= form_tag reviews_path, method: :get, class: 'filter-form' do %>
  <fieldset class="box">
    <legend>ç¯©é¸æ¢ä»¶</legend>
    
    <div class="filter-row">
      <div class="filter-field">
        <%= label_tag :review_status, 'å¯©æ ¸ç‹€æ…‹' %>
        <%= select_tag :review_status, options_for_select([
          ['å…¨éƒ¨', ''],
          ['å¾…å¯©æ ¸', 'pending'],
          ['å·²æ ¸å‡†', 'approved'],
          ['å·²æ‹’çµ•', 'rejected']
        ], params[:review_status]) %>
      </div>
      
      <div class="filter-field">
        <%= label_tag :risk_level, 'é¢¨éšªç­‰ç´š' %>
        <%= select_tag :risk_level, options_for_select([
          ['å…¨éƒ¨', ''],
          ['é«˜é¢¨éšª', 'high'],
          ['ä¸­é¢¨éšª', 'medium'],
          ['ä½é¢¨éšª', 'low']
        ], params[:risk_level]) %>
      </div>
      
      <div class="filter-field">
        <%= label_tag :project_id, 'å°ˆæ¡ˆ' %>
        <%= select_tag :project_id, options_from_collection_for_select(Project.visible, :id, :name, params[:project_id]), 
            prompt: 'å…¨éƒ¨å°ˆæ¡ˆ' %>
      </div>
    </div>
    
    <div class="filter-row">
      <div class="filter-field">
        <%= label_tag :keyword, 'é—œéµå­—æœå°‹' %>
        <%= text_field_tag :keyword, params[:keyword], placeholder: 'æœå°‹å…§å®¹ã€åµæ¸¬æ¨¡å¼æˆ–å¯©æ ¸æ„è¦‹' %>
      </div>
      
      <div class="filter-field">
        <%= label_tag :requires_review, 'éœ€è¦å¯©æ ¸' %>
        <%= check_box_tag :requires_review, 'true', params[:requires_review] == 'true' %>
      </div>
      
      <div class="filter-actions">
        <%= submit_tag 'ç¯©é¸', class: 'button' %>
        <%= link_to 'æ¸…é™¤', reviews_path, class: 'button' %>
      </div>
    </div>
  </fieldset>
<% end %>

<!-- æ‰¹é‡æ“ä½œ -->
<% if @logs.any? %>
  <div class="bulk-actions">
    <h3>æ‰¹é‡æ“ä½œ</h3>
    <%= form_tag bulk_approve_reviews_path, method: :post, data: { confirm: 'ç¢ºå®šè¦æ ¸å‡†é¸ä¸­çš„è¨˜éŒ„å—ï¼Ÿ' } do %>
      <%= hidden_field_tag :log_ids, '', id: 'selected_log_ids' %>
      <%= text_area_tag :comment, '', placeholder: 'å¯©æ ¸æ„è¦‹ï¼ˆå¯é¸ï¼‰', rows: 2 %>
      <%= select_tag :decision, options_for_select([
        ['å…è¨±', 'allow'],
        ['ä¿®æ”¹', 'modify'],
        ['å‡ç´š', 'escalate']
      ]) %>
      <%= submit_tag 'æ‰¹é‡æ ¸å‡†', class: 'button positive' %>
    <% end %>
    
    <%= form_tag bulk_reject_reviews_path, method: :post, data: { confirm: 'ç¢ºå®šè¦æ‹’çµ•é¸ä¸­çš„è¨˜éŒ„å—ï¼Ÿ' } do %>
      <%= hidden_field_tag :log_ids, '', id: 'selected_log_ids_reject' %>
      <%= text_area_tag :comment, '', placeholder: 'æ‹’çµ•åŸå› ï¼ˆå¿…å¡«ï¼‰', rows: 2, required: true %>
      <%= select_tag :decision, options_for_select([
        ['é˜»æ“‹', 'block'],
        ['ä¿®æ”¹', 'modify'],
        ['å‡ç´š', 'escalate']
      ]) %>
      <%= submit_tag 'æ‰¹é‡æ‹’çµ•', class: 'button negative' %>
    <% end %>
  </div>
<% end %>

<!-- è¨˜éŒ„åˆ—è¡¨ -->
<% if @logs.any? %>
  <div class="logs-table">
    <table class="list">
      <thead>
        <tr>
          <th><%= check_box_tag 'select_all', '1', false, id: 'select_all_logs' %></th>
          <th>ID</th>
          <th>æ“ä½œè€…</th>
          <th>å°ˆæ¡ˆ</th>
          <th>å…§å®¹é¡å‹</th>
          <th>é¢¨éšªç­‰ç´š</th>
          <th>å¯©æ ¸ç‹€æ…‹</th>
          <th>æ“ä½œæ™‚é–“</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <% @logs.each do |log| %>
          <tr class="<%= cycle('odd', 'even') %> log-row" data-log-id="<%= log.id %>">
            <td><%= check_box_tag "log_ids[]", log.id, false, class: 'log-checkbox' %></td>
            <td><%= log.id %></td>
            <td><%= log.user.name %></td>
            <td><%= log.project&.name || 'ç³»çµ±' %></td>
            <td><%= log.content_type_display %></td>
            <td>
              <span class="risk-level risk-<%= log.risk_level %>">
                <%= log.risk_level_display %>
              </span>
            </td>
            <td>
              <span class="review-status review-<%= log.review_status %>">
                <%= log.review_status_display %>
              </span>
            </td>
            <td><%= format_time(log.created_at) %></td>
            <td>
              <%= link_to 'æŸ¥çœ‹', review_path(log), class: 'icon icon-view' %>
              <% if log.can_be_reviewed? %>
                <%= link_to 'æ ¸å‡†', approve_review_path(log), method: :post, 
                    class: 'icon icon-checked', data: { confirm: 'ç¢ºå®šè¦æ ¸å‡†æ­¤è¨˜éŒ„å—ï¼Ÿ' } %>
                <%= link_to 'æ‹’çµ•', reject_review_path(log), method: :post, 
                    class: 'icon icon-del', data: { confirm: 'ç¢ºå®šè¦æ‹’çµ•æ­¤è¨˜éŒ„å—ï¼Ÿ' } %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <%= paginate @logs %>
<% else %>
  <p class="nodata">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p>
<% end %>

<script>
$(document).ready(function() {
  // å…¨é¸åŠŸèƒ½
  $('#select_all_logs').change(function() {
    $('.log-checkbox').prop('checked', $(this).is(':checked'));
    updateSelectedIds();
  });
  
  // å€‹åˆ¥é¸æ“‡
  $('.log-checkbox').change(function() {
    updateSelectedIds();
  });
  
  function updateSelectedIds() {
    var selectedIds = [];
    $('.log-checkbox:checked').each(function() {
      selectedIds.push($(this).val());
    });
    $('#selected_log_ids, #selected_log_ids_reject').val(selectedIds.join(','));
  }
});
</script>
