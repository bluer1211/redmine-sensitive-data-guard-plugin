<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'sensitive_data_guard', plugin: 'redmine_sensitive_data_guard' %>
<% end %>

<div class="sensitive-data-guard-settings">
  <h2>ğŸ”’ æ•æ„Ÿè³‡æ–™é˜²è­·è¨­å®š</h2>
  
  <!-- åŸºæœ¬è¨­å®š -->
  <fieldset class="box">
    <legend>åŸºæœ¬è¨­å®š</legend>
    
    <p>
      <label>
        <%= check_box_tag 'settings[enabled]', 1, @settings['enabled'] %>
        å•Ÿç”¨æ•æ„Ÿè³‡æ–™é˜²è­·åŠŸèƒ½
      </label>
    </p>
    
    <p>
      <label>
        <%= check_box_tag 'settings[enable_file_scanning]', 1, @settings['enable_file_scanning'] %>
        å•Ÿç”¨æª”æ¡ˆæƒæ
      </label>
    </p>
    
    <p>
      <label for="settings[max_file_size_mb]">æœ€å¤§æª”æ¡ˆå¤§å° (MB):</label>
      <%= number_field_tag 'settings[max_file_size_mb]', @settings['max_file_size_mb'], 
          min: 1, max: 100, size: 10 %>
    </p>
  </fieldset>
  
  <!-- é¢¨éšªç­‰ç´šè¨­å®š -->
  <fieldset class="box">
    <legend>é¢¨éšªç­‰ç´šè¨­å®š</legend>
    
    <!-- é«˜é¢¨éšª -->
    <div class="risk-level">
      <h4>ğŸ”´ é«˜é¢¨éšªåµæ¸¬</h4>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_high_risk_detection]', 1, @settings['enable_high_risk_detection'] != false %>
          å•Ÿç”¨é«˜é¢¨éšªåµæ¸¬
        </label>
      </p>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_taiwan_id_detection]', 1, @settings['enable_taiwan_id_detection'] != false %>
          å°ç£èº«åˆ†è­‰è™Ÿç¢¼
        </label>
      </p>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_credit_card_detection]', 1, @settings['enable_credit_card_detection'] != false %>
          ä¿¡ç”¨å¡è™Ÿç¢¼
        </label>
      </p>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_password_keyword_detection]', 1, @settings['enable_password_keyword_detection'] != false %>
          å¯†ç¢¼é—œéµå­—
        </label>
      </p>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_credential_combination_detection]', 1, @settings['enable_credential_combination_detection'] != false %>
          å¸³è™Ÿå¯†ç¢¼çµ„åˆ
        </label>
      </p>
      <p>
        <label for="settings[high_risk_strategy]">è™•ç†ç­–ç•¥:</label>
        <%= select_tag 'settings[high_risk_strategy]', 
            options_for_select([
              ['é˜»æ“‹', 'block'],
              ['è­¦å‘Š', 'warn'],
              ['è¨˜éŒ„', 'log']
            ], @settings['high_risk_strategy'] || 'block') %>
      </p>
    </div>
    
    <!-- ä¸­é¢¨éšª -->
    <div class="risk-level">
      <h4>ğŸŸ¡ ä¸­é¢¨éšªåµæ¸¬</h4>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_medium_risk_detection]', 1, @settings['enable_medium_risk_detection'] != false %>
          å•Ÿç”¨ä¸­é¢¨éšªåµæ¸¬
        </label>
      </p>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_taiwan_mobile_detection]', 1, @settings['enable_taiwan_mobile_detection'] != false %>
          å°ç£æ‰‹æ©Ÿè™Ÿç¢¼
        </label>
      </p>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_internal_ip_detection]', 1, @settings['enable_internal_ip_detection'] != false %>
          å…§éƒ¨ IP ä½å€
        </label>
      </p>
      <p>
        <label for="settings[medium_risk_strategy]">è™•ç†ç­–ç•¥:</label>
        <%= select_tag 'settings[medium_risk_strategy]', 
            options_for_select([
              ['é˜»æ“‹', 'block'],
              ['è­¦å‘Š', 'warn'],
              ['è¨˜éŒ„', 'log']
            ], @settings['medium_risk_strategy'] || 'warn') %>
      </p>
    </div>
    
    <!-- ä½é¢¨éšª -->
    <div class="risk-level">
      <h4>ğŸŸ¢ ä½é¢¨éšªåµæ¸¬</h4>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_low_risk_detection]', 1, @settings['enable_low_risk_detection'] != false %>
          å•Ÿç”¨ä½é¢¨éšªåµæ¸¬
        </label>
      </p>
      <p>
        <label>
          <%= check_box_tag 'settings[enable_email_detection]', 1, @settings['enable_email_detection'] != false %>
          Email åœ°å€
        </label>
      </p>
      <p>
        <label for="settings[low_risk_strategy]">è™•ç†ç­–ç•¥:</label>
        <%= select_tag 'settings[low_risk_strategy]', 
            options_for_select([
              ['é˜»æ“‹', 'block'],
              ['è­¦å‘Š', 'warn'],
              ['è¨˜éŒ„', 'log']
            ], @settings['low_risk_strategy'] || 'log') %>
      </p>
    </div>
  </fieldset>
  
  <!-- é€šçŸ¥è¨­å®š -->
  <fieldset class="box">
    <legend>é€šçŸ¥è¨­å®š</legend>
    
    <p>
      <label>
        <%= check_box_tag 'settings[email_notifications]', 1, @settings['email_notifications'] %>
        å•Ÿç”¨ Email é€šçŸ¥
      </label>
    </p>
    
    <p>
      <label for="settings[notification_recipients]">æ”¶ä»¶äºº Email:</label>
      <%= text_field_tag 'settings[notification_recipients]', @settings['notification_recipients'], 
          size: 60, placeholder: 'admin@example.com, security@company.com' %>
      <br><small>å¤šå€‹ Email è«‹ç”¨é€—è™Ÿåˆ†éš”</small>
    </p>
    
    <p>
      <label for="settings[notification_frequency]">é€šçŸ¥é »ç‡:</label>
      <%= select_tag 'settings[notification_frequency]', 
          options_for_select([
            ['ç«‹å³', 'immediate'],
            ['æ¯å°æ™‚', 'hourly'],
            ['æ¯æ—¥', 'daily'],
            ['æ¯é€±', 'weekly']
          ], @settings['notification_frequency'] || 'immediate') %>
    </p>
    
    <p>
      <label for="settings[slack_webhook_url]">Slack Webhook URL:</label>
      <%= text_field_tag 'settings[slack_webhook_url]', @settings['slack_webhook_url'], 
          size: 60, placeholder: 'https://hooks.slack.com/services/...' %>
    </p>
    
    <!-- Email æ¸¬è©¦åŠŸèƒ½ -->
    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
      <h4>ğŸ§ª Email æ¸¬è©¦åŠŸèƒ½</h4>
      <p>
        <label for="test_email_recipients">æ¸¬è©¦æ”¶ä»¶äºº:</label>
        <%= text_field_tag 'test_email_recipients', @settings['notification_recipients'], 
            size: 60, placeholder: 'test@example.com', id: 'test_email_recipients' %>
        <br><small>è¼¸å…¥è¦æ¸¬è©¦çš„ Email åœ°å€</small>
      </p>
      <p>
        <%= button_tag 'ğŸ“§ ç™¼é€æ¸¬è©¦ Email', type: 'button', 
            onclick: 'sendTestEmail()', 
            style: 'background: #007cba; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;' %>
        <span id="test_email_status" style="margin-left: 10px;"></span>
      </p>
    </div>
  </fieldset>
  
  <!-- æ—¥èªŒä¿ç•™è¨­å®š -->
  <fieldset class="box">
    <legend>æ—¥èªŒä¿ç•™è¨­å®š</legend>
    
    <p>
      <label for="settings[retention_days_high_risk]">é«˜é¢¨éšªæ—¥èªŒä¿ç•™å¤©æ•¸:</label>
      <%= number_field_tag 'settings[retention_days_high_risk]', @settings['retention_days_high_risk'], 
          min: 365, max: 3650, size: 10 %>
    </p>
    
    <p>
      <label for="settings[retention_days_standard]">æ¨™æº–æ—¥èªŒä¿ç•™å¤©æ•¸:</label>
      <%= number_field_tag 'settings[retention_days_standard]', @settings['retention_days_standard'], 
          min: 30, max: 3650, size: 10 %>
    </p>
    
    <p>
      <label>
        <%= check_box_tag 'settings[auto_cleanup_enabled]', 1, @settings['auto_cleanup_enabled'] %>
        å•Ÿç”¨è‡ªå‹•æ¸…ç†éæœŸæ—¥èªŒ
      </label>
    </p>
  </fieldset>
  
  <!-- å¿«é€Ÿæ“ä½œ -->
  <fieldset class="box">
    <legend>å¿«é€Ÿæ“ä½œ</legend>
    
    <p>
      <%= link_to 'ğŸ“Š æŸ¥çœ‹æ•æ„Ÿæ“ä½œæ—¥èªŒ', sensitive_logs_path, class: 'button' %>
      <%= link_to 'ğŸ§¹ æ¸…ç†éæœŸæ—¥èªŒ', cleanup_sensitive_logs_path, method: :post, 
          data: { confirm: 'ç¢ºå®šè¦æ¸…ç†éæœŸæ—¥èªŒå—ï¼Ÿ' }, class: 'button' %>
      <%= link_to 'ğŸ“‹ é¢¨éšªç­‰ç´šèªªæ˜', risk_levels_sensitive_logs_path, class: 'button' %>
    </p>
  </fieldset>
</div>

<script>
function sendTestEmail() {
  const recipients = document.getElementById('test_email_recipients').value.trim();
  const statusElement = document.getElementById('test_email_status');
  
  if (!recipients) {
    statusElement.innerHTML = '<span style="color: red;">âŒ è«‹è¼¸å…¥æ”¶ä»¶äºº Email åœ°å€</span>';
    return;
  }
  
  // é¡¯ç¤ºç™¼é€ä¸­ç‹€æ…‹
  statusElement.innerHTML = '<span style="color: blue;">â³ ç™¼é€ä¸­...</span>';
  
  // ç™¼é€ AJAX è«‹æ±‚
  fetch('/sensitive_data_guard_settings/test_email', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify({ recipients: recipients })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      statusElement.innerHTML = '<span style="color: green;">âœ… ' + data.message + '</span>';
    } else {
      statusElement.innerHTML = '<span style="color: red;">âŒ ' + data.message + '</span>';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    statusElement.innerHTML = '<span style="color: red;">âŒ ç™¼é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</span>';
  });
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // å¦‚æœè¨­å®šä¸­æœ‰æ”¶ä»¶äººï¼Œè‡ªå‹•å¡«å…¥æ¸¬è©¦æ¬„ä½
  const notificationRecipients = document.querySelector('input[name="settings[notification_recipients]"]');
  const testRecipients = document.getElementById('test_email_recipients');
  
  if (notificationRecipients && testRecipients && notificationRecipients.value) {
    testRecipients.value = notificationRecipients.value;
  }
});
</script> 